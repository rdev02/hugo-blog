<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.70.0 with theme Tranquilpeak 0.4.7-BETA">
<meta name="author" content="Viktor Halitsyn">
<meta name="keywords" content=", code, travel, immigration, ukraine, washington">
<meta name="description" content="There are a few articles on the web describing how to load assemblies using reflection, thus allowing you to execute third-party code inside your own application. While applicable in most cases, my customer wanted those plugins to be replaceable on-the-fly. Keep mind that once an assembly has been loaded into an application domain it cannot be unloaded unless you unload the domain(which is you main app domain by default)=close the application.">


<meta property="og:description" content="There are a few articles on the web describing how to load assemblies using reflection, thus allowing you to execute third-party code inside your own application. While applicable in most cases, my customer wanted those plugins to be replaceable on-the-fly. Keep mind that once an assembly has been loaded into an application domain it cannot be unloaded unless you unload the domain(which is you main app domain by default)=close the application.">
<meta property="og:type" content="article">
<meta property="og:title" content="Creating dynamic plugin architecture with C#.NET">
<meta name="twitter:title" content="Creating dynamic plugin architecture with C#.NET">
<meta property="og:url" content="http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
<meta property="twitter:url" content="http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
<meta property="og:site_name" content="Nomad&#39;s reflections">
<meta property="og:description" content="There are a few articles on the web describing how to load assemblies using reflection, thus allowing you to execute third-party code inside your own application. While applicable in most cases, my customer wanted those plugins to be replaceable on-the-fly. Keep mind that once an assembly has been loaded into an application domain it cannot be unloaded unless you unload the domain(which is you main app domain by default)=close the application.">
<meta name="twitter:description" content="There are a few articles on the web describing how to load assemblies using reflection, thus allowing you to execute third-party code inside your own application. While applicable in most cases, my customer wanted those plugins to be replaceable on-the-fly. Keep mind that once an assembly has been loaded into an application domain it cannot be unloaded unless you unload the domain(which is you main app domain by default)=close the application.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2009-12-12T23:11:00">
  
  
    <meta property="article:modified_time" content="2009-12-12T23:11:00">
  
  
  
    
      <meta property="article:section" content="tech">
    
      <meta property="article:section" content="code">
    
  
  
    
      <meta property="article:tag" content=".net">
    
      <meta property="article:tag" content="c#">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@rdev02">


  <meta name="twitter:creator" content="@rdev02">










  <meta property="og:image" content="https://www.gravatar.com/avatar/d96a6dd84105118027bb67e3396ba7e4?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/d96a6dd84105118027bb67e3396ba7e4?s=640">


    <title>Creating dynamic plugin architecture with C#.NET</title>

    <link rel="icon" href="/favicon.jpg">
    

    
      <link rel="publisher" href="https://plus.google.com/&#43;victorhalitsyn">
    

    <link rel="canonical" href="http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://fonts.googleapis.com/css?family=Oswald|Roboto">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-64535001-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="3">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">Nomad&#39;s reflections</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="3">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/d96a6dd84105118027bb67e3396ba7e4?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Viktor Halitsyn</h4>
        
          <h5 class="sidebar-profile-bio">Came a long way from Ukraine, still so much to go&hellip;</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/rdev02" target="_blank" rel="noopener">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/rdev02" target="_blank" rel="noopener">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i style="color:black" class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="3"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Creating dynamic plugin architecture with C#.NET
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2009-12-12T23:11:00Z">
        
  
  
  
  
    12/12/2009
  

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/categories/tech">tech</a>, 
    
      <a class="category-link" href="/categories/code">code</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>There are a few articles on the web describing how to load assemblies using reflection, thus allowing you to execute third-party code inside your own application. While applicable in most cases, my customer wanted those plugins to be replaceable on-the-fly. Keep mind that once an assembly has been loaded into an application domain it cannot be unloaded unless you unload the domain(which is you main app domain by default)=close the application. Also Loading dll’s in the main application domain is very risky in terms of security concerns. But back to the problem – as long as your assembly is loaded into any domain it is locked, meaning that you can’t replace it with the newer version.</p>
<p>Naturally you’ll turn to creating a separate app domain. and try to AppDomain.load() assembly there… Now that’s the time you’ll start experiencing problems. <a href="http://msdn.microsoft.com/en-us/library/36az8x58.aspx">Here </a>we can get smth like “<span style="font-family: Verdana,Arial,Helvetica,sans-serif; font-size: 11px;">This method should only be used to load an assembly into the current application domain. This method is defined for interoperability callers who cannot call the static <a href="http://msdn.microsoft.com/en-us/library/system.reflection.assembly.load.aspx" style="color: #0033cc; text-decoration: none;">Load</a> method.<span style="font-family: 'Times New Roman'; font-size: medium;">” In short – you’ll fail to load the assembly having its path. Well, actually what you really need is to be able to get some object out of there, right? Suppose you use simple “middle-tier-interface” assembly like<br /> </span></span></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">namespace</span> PInterface
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> PluginInterface
    {
        <span style="color:#66d9ef">string</span> DoSmth();
    }
}
</code></pre></div><p>Then when you want to load Some type, let it be like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">namespace</span> SamplePlugin
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Plugin1</span> :MarshalByRefObject, PluginInterface
    {
        <span style="color:#75715e">#region PluginInterface
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> DoSmth()
        {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello!&#34;</span>;
        }

        <span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>    }
}
</code></pre></div><p>You would simply do it like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">AppDomain newDomain = AppDomain.CreateDomain(<span style="color:#e6db74">&#34;newDOmain&#34;</span>);
newDomain.CreateInstanceFromAndUnwrap(pathToDLL, pluginClassName);
</code></pre></div><p>Assuming you know the class name(s) of course:). If you don’t, then it’s 2 choices: either you specify that the plugin assembly has to have a “marker” type (say “class PluginType{}”) and then after loading an assembly into app domain execute the callback on it to get the class names via reflection load OR you might end up with a crossDomain walker like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.Windows.Forms;
<span style="color:#66d9ef">using</span> System.Reflection;

<span style="color:#66d9ef">namespace</span> WindowsApplication1
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> PLUGIN_INTERFACE_NAME = <span style="color:#e6db74">&#34;PluginInterfaceName&#34;</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> PLUGIN_CLASSES_NAMES = <span style="color:#e6db74">&#34;PluginClasses&#34;</span>;
        <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// The main entry point for the application.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">        [STAThread]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> Main(String[] args)
        {
            <span style="color:#66d9ef">object</span> interfaceName =  AppDomain.CurrentDomain.GetData(PLUGIN_INTERFACE_NAME);
            List&lt;<span style="color:#66d9ef">string</span>&gt; pluginClassesNames = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;(<span style="color:#ae81ff">3</span>);
            <span style="color:#66d9ef">if</span> (args.Length &gt; <span style="color:#ae81ff">0</span>)
            {
                <span style="color:#66d9ef">string</span> sInterfaceName = (<span style="color:#66d9ef">string</span>)interfaceName;
                <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">string</span> arg <span style="color:#66d9ef">in</span> args)
                <span style="color:#66d9ef">try</span>
                {
                    Assembly asm = Assembly.LoadFrom(arg);
                    Type[] possiblePlugins = asm.GetTypes();
                    List&lt;Type&gt; realCandidates = <span style="color:#66d9ef">new</span> List&lt;Type&gt;(<span style="color:#ae81ff">3</span>);
                    <span style="color:#66d9ef">foreach</span> (Type t <span style="color:#66d9ef">in</span> possiblePlugins)
                    {
                        <span style="color:#66d9ef">if</span> (!t.IsAbstract &amp;&amp; !t.IsInterface &amp;&amp; (t.GetInterface(sInterfaceName) != <span style="color:#66d9ef">null</span>))
                            pluginClassesNames.Add(t.FullName);
                    }
                }
                <span style="color:#66d9ef">catch</span> (Exception ex)
                {
                    pluginClassesNames.Add(<span style="color:#e6db74">&#34;Exception &#34;</span> + ex.ToString());
                }
            }

            AppDomain.CurrentDomain.SetData(PLUGIN_CLASSES_NAMES, pluginClassesNames.ToArray());
            <span style="color:#66d9ef">return</span> pluginClassesNames.Count;            
        }
    }
}
</code></pre></div><p>using it won’t be a problem:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">int</span> execRes = newDomain.ExecuteAssembly(_classFinderAssemblyPath, AppDomain.CurrentDomain.Evidence, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] { path });
<span style="color:#66d9ef">if</span> (execRes &lt;= <span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;No plugins found in &#34;</span> + path);
<span style="color:#66d9ef">string</span>[] pluginClasses = (<span style="color:#66d9ef">string</span>[])newDomain.GetData(PLUGIN_CLASSES_NAMES);
</code></pre></div><p>Then calling a simple AppDomain.Unload(); would solve your problem. If you are lucky enough to have a pure .NET world and are not concerned about security, then you’re definitely lucky. And I am not :):(.</p>
<pre><code>Let us now assume you want those plugins to be consumable from the c++ application. Suppose your client has a big c++ app and now realized developing plugins in .NET would be easier. Then your natural choice is to make it as much less painful for c++ app to use you code as possible. A solution to that would be to have a .NET plugin manager, exposed to c++ app via the COM object. You may end up with smth. like this:
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.Text;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;
<span style="color:#66d9ef">using</span> System.Reflection;
<span style="color:#66d9ef">using</span> System.IO;
<span style="color:#66d9ef">using</span> System.Runtime.Remoting;
<span style="color:#66d9ef">using</span> System.Security.Policy;
<span style="color:#66d9ef">using</span> System.Security;
<span style="color:#66d9ef">using</span> System.Security.Permissions;

<span style="color:#66d9ef">namespace</span> ComPluginManager
{
<span style="color:#a6e22e">    [ComVisible(true)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PluginManger</span>: IPluginManager
    {
        <span style="color:#66d9ef">private</span> IDictionary&lt;String, AppDomain&gt; _pluginStore;
        <span style="color:#66d9ef">private</span> String _interfaceName = <span style="color:#e6db74">&#34;PluginInterface&#34;</span>;
        <span style="color:#66d9ef">private</span> String _classFinderAssemblyPath;
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> PLUGIN_INTERFACE_NAME = <span style="color:#e6db74">&#34;PluginInterfaceName&#34;</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> PLUGIN_CLASSES_NAMES = <span style="color:#e6db74">&#34;PluginClasses&#34;</span>;

        <span style="color:#66d9ef">public</span> PluginManger()
        {
            _pluginStore = <span style="color:#66d9ef">new</span> Dictionary&lt;String, AppDomain&gt;(<span style="color:#ae81ff">5</span>);
        }

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">object</span>[] LoadPlugin(<span style="color:#66d9ef">string</span> path) {
            List&lt;<span style="color:#66d9ef">object</span>&gt; result = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">object</span>&gt;(<span style="color:#ae81ff">3</span>);
            
            AppDomainSetup setup = <span style="color:#66d9ef">new</span> AppDomainSetup();
            setup.ApplicationBase = Path.GetDirectoryName(path); <span style="color:#75715e">// plugin path
</span><span style="color:#75715e"></span>            PermissionSet trustPermissionSet = <span style="color:#66d9ef">new</span> PermissionSet(PermissionState.Unrestricted);
            AppDomain newDomain = AppDomain.CreateDomain(
                String.Format(<span style="color:#e6db74">&#34;Domain{0}&#34;</span>, Path.GetFileName(path)),
                <span style="color:#66d9ef">null</span>,
                setup,
                trustPermissionSet);

            <span style="color:#66d9ef">try</span>
            {
                newDomain.SetData(PLUGIN_INTERFACE_NAME, <span style="color:#e6db74">&#34;PluginInterface&#34;</span>);
                <span style="color:#66d9ef">int</span> execRes = newDomain.ExecuteAssembly(_classFinderAssemblyPath, AppDomain.CurrentDomain.Evidence, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] { path });
                <span style="color:#66d9ef">if</span> (execRes &lt;= <span style="color:#ae81ff">0</span>)
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;No plugins found in &#34;</span> + path);
                <span style="color:#66d9ef">string</span>[] pluginClasses = (<span style="color:#66d9ef">string</span>[])newDomain.GetData(PLUGIN_CLASSES_NAMES);

                _pluginStore[path] = newDomain;
                <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">string</span> pluginClass <span style="color:#66d9ef">in</span> pluginClasses)
             {
                    ObjectHandle objHandle = Activator.CreateInstanceFrom(newDomain, path, pluginClass);

                    <span style="color:#66d9ef">if</span> (objHandle != <span style="color:#66d9ef">null</span>)
                    {
                        <span style="color:#66d9ef">object</span> unwrappedInstance = objHandle.Unwrap();
                        result.Add(unwrappedInstance);
                    }

                    result.Add(_pluginStore[path].CreateInstanceFromAndUnwrap(path, pluginClass));
             }
                
            }
            <span style="color:#66d9ef">catch</span> (Exception ex) { 
                result.Add(ex);
            }       
            <span style="color:#66d9ef">return</span> result.ToArray();
        }     

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> UnloadPlugin(<span style="color:#66d9ef">string</span> path) {
            <span style="color:#66d9ef">try</span>
            {
                AppDomain domain = _pluginStore[path];
                _pluginStore.Remove(path);
                AppDomain.Unload(domain);
            }
            <span style="color:#66d9ef">catch</span> (Exception ex)
            { ;}
        }

        <span style="color:#66d9ef">public</span> String InterfaceName { <span style="color:#66d9ef">get</span> { <span style="color:#66d9ef">return</span> _interfaceName; } <span style="color:#66d9ef">set</span> { _interfaceName = <span style="color:#66d9ef">value</span>; } }

        <span style="color:#66d9ef">public</span> String ClassFinderAssemblyPath { <span style="color:#66d9ef">get</span> { <span style="color:#66d9ef">return</span> _classFinderAssemblyPath; } <span style="color:#66d9ef">set</span> { _classFinderAssemblyPath = <span style="color:#66d9ef">value</span>; } }
        
    }
}
</code></pre></div><p>And it’s interface of course like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.Text;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;

<span style="color:#66d9ef">namespace</span> ComPluginManager
{
<span style="color:#a6e22e">    [ComVisible(true)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> IPluginManager
    {
        String InterfaceName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

        String ClassFinderAssemblyPath { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>;}
        <span style="color:#66d9ef">void</span> UnloadPlugin(String path);
        Object[] LoadPlugin(String path);
    }
}
</code></pre></div><p>Two things to notice here: I haven’t managed to get the plain class’s public methods visible to C++ so I used an interface. And second, probably the most important – <span style="font-family: monospace; white-space: pre;">PermissionSet.</span> If you do not set this you wont be able to anything inside you app domain, except the very basic things like calculations and maybe some other data manipulation. You can find more info on this <a href="http://blogs.msdn.com/shawnfa/archive/2004/11/02/251239.aspx">here</a> and <a href="http://blogs.msdn.com/shawnfa/archive/2004/10/26/248114.aspx">here</a>.</p>
<p>Another important thing is that as long as your code is going to be executed from an unmanaged environment and want to do smth with partially trusted code – you have to use</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#a6e22e">[assembly: AllowPartiallyTrustedCallersAttribute()]</span>
</code></pre></div><p>In both manager and plugin assemblies. Further explanation on how it works can be found <a href="http://msdn.microsoft.com/en-us/magazine/cc163701.aspx">here</a>.</p>
<p>Now if you <span style="text-decoration: line-through;">crossed your fingers at the right moment</span> did everything wright this plugin manager would load assemblies for you, return you the instantiated objects and free the dlls on your request flawlesly.</p>
<p>And you will be able to put that shiny “Update” button on the toolbar without asking the user to reboot/restart an application whenever you need the  plugin update. And not bother with temporary files and “special” startup routines… etc. I think the idea is clear 🙂</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/.net/">.net</a>

  <a class="tag tag--primary tag--small" href="/tags/c/">c#</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/code/devenv-crash-from-the-command-line/" data-tooltip="Devenv crash from the command line.">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/code/sad-funny-world-of-mobile-development/" data-tooltip="Sad &amp; funny world of mobile development.">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Viktor Halitsyn. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/code/devenv-crash-from-the-command-line/" data-tooltip="Devenv crash from the command line.">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/code/sad-funny-world-of-mobile-development/" data-tooltip="Sad &amp; funny world of mobile development.">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://blog.vnomad.com/code/creating-dynamic-plugin-architecture-with-c-net/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="3">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fblog.vnomad.com%2Fcode%2Fcreating-dynamic-plugin-architecture-with-c-net%2F">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http%3A%2F%2Fblog.vnomad.com%2Fcode%2Fcreating-dynamic-plugin-architecture-with-c-net%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/d96a6dd84105118027bb67e3396ba7e4?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Viktor Halitsyn</h4>
    
      <div id="about-card-bio">Came a long way from Ukraine, still so much to go&hellip;</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        software engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Seattle, WA
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://s3-us-west-2.amazonaws.com/vnomad-public/blog_infra/wp_back3.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'http:\/\/blog.vnomad.com\/code\/creating-dynamic-plugin-architecture-with-c-net\/';
          
            this.page.identifier = '5821225733';
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'vnomad';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

